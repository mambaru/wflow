<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - wflow-coverage.info - wflow/workflow.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">wflow</a> - workflow.cpp<span style="font-size: 80%;"> (source / <a href="workflow.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">wflow-coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">69</td>
            <td class="headerCovTableEntry">144</td>
            <td class="headerCovTableEntryLo">47.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2019-09-13</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntry">49</td>
            <td class="headerCovTableEntryLo">44.9 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &quot;logger.hpp&quot;</a>
<span class="lineNum">       2 </span>            : #include &lt;wflow/queue/bique.hpp&gt;
<span class="lineNum">       3 </span>            : #include &quot;workflow.hpp&quot;
<span class="lineNum">       4 </span>            : 
<a name="5"><span class="lineNum">       5 </span>            : namespace wflow{</a>
<span class="lineNum">       6 </span>            :   
<span class="lineNum">       7 </span><span class="lineCov">         14 : workflow::~workflow()</span>
<span class="lineNum">       8 </span>            : {
<span class="lineNum">       9 </span><span class="lineCov">          7 :   this-&gt;stop();</span>
<span class="lineNum">      10 </span><span class="lineCov">          7 :   _impl = nullptr;</span>
<a name="11"><span class="lineNum">      11 </span><span class="lineCov">          7 : }</span></a>
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span><span class="lineCov">          2 : workflow::workflow(const workflow_options&amp; opt, const workflow_handlers&amp; handlers )</span>
<span class="lineNum">      14 </span>            :   : _delay_ms(opt.post_delay_ms)
<span class="lineNum">      15 </span>            :   , _impl( std::make_shared&lt;task_manager&gt;(opt) )
<span class="lineNum">      16 </span>            :   , _opt(opt)
<span class="lineNum">      17 </span><span class="lineCov">          2 :   , _handlers(handlers)</span>
<span class="lineNum">      18 </span>            : {
<span class="lineNum">      19 </span><span class="lineCov">          2 :   this-&gt;initialize_();</span>
<a name="20"><span class="lineNum">      20 </span><span class="lineCov">          2 : }</span></a>
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span><span class="lineCov">          5 : workflow::workflow(io_service_type&amp; io, const workflow_options&amp; opt, const workflow_handlers&amp; handlers)</span>
<span class="lineNum">      23 </span>            :   : _delay_ms(opt.post_delay_ms)
<span class="lineNum">      24 </span>            :   , _impl( std::make_shared&lt;task_manager&gt;(io, opt) )
<span class="lineNum">      25 </span>            :   , _opt(opt)
<span class="lineNum">      26 </span><span class="lineCov">          5 :   , _handlers(handlers)</span>
<span class="lineNum">      27 </span>            : {
<span class="lineNum">      28 </span><span class="lineCov">          5 :   this-&gt;initialize_();</span>
<span class="lineNum">      29 </span><span class="lineCov">          5 : }</span>
<a name="30"><span class="lineNum">      30 </span>            : </a>
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span><span class="lineCov">          9 : void workflow::start()</span>
<span class="lineNum">      33 </span>            : {
<span class="lineNum">      34 </span><span class="lineCov">          9 :   _impl-&gt;start();</span>
<a name="35"><span class="lineNum">      35 </span><span class="lineCov">          9 : }</span></a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineNoCov">          0 : bool workflow::reconfigure(const workflow_options&amp; opt)</span>
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :   return this-&gt;reconfigure(opt, this-&gt;get_handlers());</span>
<a name="40"><span class="lineNum">      40 </span>            : }</a>
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span><span class="lineNoCov">          0 : bool workflow::reconfigure(const workflow_handlers&amp; handlers)</span>
<span class="lineNum">      43 </span>            : {
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :   return this-&gt;reconfigure(this-&gt;get_options(), handlers);</span>
<a name="45"><span class="lineNum">      45 </span>            : }</a>
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span><span class="lineNoCov">          0 : bool workflow::reconfigure(const workflow_options&amp; opt, const workflow_handlers&amp; handlers)</span>
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :   if ( !_impl-&gt;reconfigure(opt) )</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   _delay_ms = opt.post_delay_ms;</span>
<span class="lineNum">      53 </span>            :   {
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     std::lock_guard&lt;mutex_type&gt; lk(_mutex);</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :     _opt = opt;</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     _handlers = handlers;</span>
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :     this-&gt;initialize_();</span>
<span class="lineNum">      58 </span>            :   }
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :   return true;</span>
<a name="60"><span class="lineNum">      60 </span>            : }</a>
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : std::string workflow::get_id() const</span>
<span class="lineNum">      63 </span>            : {
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   std::lock_guard&lt;mutex_type&gt; lk(_mutex);</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   return _opt.id;</span>
<a name="66"><span class="lineNum">      66 </span>            : }</a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 : void workflow::reset()</span>
<span class="lineNum">      69 </span>            : {
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :   _impl-&gt;reset();</span>
<a name="71"><span class="lineNum">      71 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span><span class="lineCov">          8 : void workflow::stop()</span>
<span class="lineNum">      74 </span>            : {
<span class="lineNum">      75 </span><span class="lineCov">          8 :   _impl-&gt;stop();</span>
<a name="76"><span class="lineNum">      76 </span><span class="lineCov">          8 : }</span></a>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">          4 : void workflow::shutdown()</span>
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span><span class="lineCov">          4 :   _impl-&gt;shutdown();</span>
<a name="81"><span class="lineNum">      81 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">      82 </span>            :   
<span class="lineNum">      83 </span><span class="lineCov">          4 : void workflow::wait()</span>
<span class="lineNum">      84 </span>            : {
<span class="lineNum">      85 </span><span class="lineCov">          4 :   _impl-&gt;wait();</span>
<a name="86"><span class="lineNum">      86 </span><span class="lineCov">          4 : }</span></a>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineCov">          1 : void workflow::wait_and_restart()</span>
<span class="lineNum">      89 </span>            : {
<span class="lineNum">      90 </span><span class="lineCov">          1 :   _impl-&gt;shutdown();</span>
<span class="lineNum">      91 </span><span class="lineCov">          1 :   _impl-&gt;wait();</span>
<span class="lineNum">      92 </span><span class="lineCov">          1 :   _impl-&gt;start();</span>
<span class="lineNum">      93 </span><span class="lineCov">          1 : }</span>
<a name="94"><span class="lineNum">      94 </span>            : </a>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : std::shared_ptr&lt; task_manager &gt; workflow::get_task_manager() const</span>
<span class="lineNum">      97 </span>            : {
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   return _impl;</span>
<a name="99"><span class="lineNum">      99 </span>            : }</a>
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineCov">          2 : std::shared_ptr&lt; workflow::timer_manager_t&gt; workflow::get_timer_manager() const</span>
<span class="lineNum">     102 </span>            : {
<span class="lineNum">     103 </span><span class="lineCov">          2 :   return _impl-&gt;get_timer_manager();</span>
<a name="104"><span class="lineNum">     104 </span>            : }</a>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 : workflow_options workflow::get_options() const</span>
<span class="lineNum">     107 </span>            : {
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   std::lock_guard&lt;mutex_type&gt; lk(_mutex);</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :   return _opt;  </span>
<a name="110"><span class="lineNum">     110 </span>            : }</a>
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span><span class="lineNoCov">          0 : workflow_handlers workflow::get_handlers() const</span>
<span class="lineNum">     113 </span>            : {
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :   std::lock_guard&lt;mutex_type&gt; lk(_mutex);</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :   return _handlers;  </span>
<a name="116"><span class="lineNum">     116 </span>            : }</a>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineNoCov">          0 : void workflow::safe_post(post_handler handler)</span>
<span class="lineNum">     119 </span>            : {
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   _impl-&gt;safe_post( handler );</span>
<a name="121"><span class="lineNum">     121 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">        419 : bool workflow::post(post_handler handler, drop_handler drop)</span>
<span class="lineNum">     124 </span>            : {
<span class="lineNum">     125 </span><span class="lineCov">        419 :   if ( _delay_ms == 0)</span>
<span class="lineNum">     126 </span><span class="lineCov">        419 :     return _impl-&gt;post( handler, drop );</span>
<span class="lineNum">     127 </span>            :   else
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     return this-&gt;post( std::chrono::milliseconds(_delay_ms), handler, drop);</span>
<a name="129"><span class="lineNum">     129 </span>            : }</a>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineNoCov">          0 : void workflow::safe_post(time_point_t tp, post_handler handler)</span>
<span class="lineNum">     132 </span>            : {
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :   _impl-&gt;safe_post_at( tp, handler );</span>
<a name="134"><span class="lineNum">     134 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineNoCov">          0 : bool workflow::post(time_point_t tp, post_handler handler, drop_handler drop)</span>
<span class="lineNum">     137 </span>            : {
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :   return _impl-&gt;post_at( tp, handler, drop);</span>
<a name="139"><span class="lineNum">     139 </span>            : }</a>
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span><span class="lineCov">          1 : void workflow::safe_post(duration_t d,   post_handler handler)</span>
<span class="lineNum">     142 </span>            : {
<span class="lineNum">     143 </span><span class="lineCov">          1 :   return _impl-&gt;safe_delayed_post(d, handler);</span>
<a name="144"><span class="lineNum">     144 </span>            : }</a>
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span><span class="lineCov">          5 : bool workflow::post(duration_t d,   post_handler handler, drop_handler drop)</span>
<span class="lineNum">     147 </span>            : {
<span class="lineNum">     148 </span><span class="lineCov">          5 :   return _impl-&gt;delayed_post(d, handler, drop);</span>
<a name="149"><span class="lineNum">     149 </span>            : }</a>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineCov">          2 : workflow::timer_id_t workflow::create_timer(duration_t d, timer_handler handler, expires_at expires)</span>
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span><span class="lineCov">          2 :   return _impl-&gt;get_timer_manager()-&gt;create(d, handler, expires );</span>
<a name="154"><span class="lineNum">     154 </span>            : }</a>
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_async_timer(duration_t d, async_timer_handler handler, expires_at expires)</span>
<span class="lineNum">     157 </span>            : {
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(d, handler, expires );</span>
<a name="159"><span class="lineNum">     159 </span>            : }</a>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_timer(duration_t sd, duration_t d, timer_handler handler, expires_at expires)</span>
<span class="lineNum">     162 </span>            : {
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create( sd, d, handler, expires );</span>
<a name="164"><span class="lineNum">     164 </span>            : }</a>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_async_timer(duration_t sd, duration_t d, async_timer_handler handler, expires_at expires)</span>
<span class="lineNum">     167 </span>            : {
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create( sd, d, handler, expires );</span>
<a name="169"><span class="lineNum">     169 </span>            : }</a>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_timer(time_point_t tp, duration_t d, timer_handler handler, expires_at expires)</span>
<span class="lineNum">     172 </span>            : {
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, d, handler, expires );</span>
<a name="174"><span class="lineNum">     174 </span>            : }</a>
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_async_timer(time_point_t tp, duration_t d, async_timer_handler handler, expires_at expires)</span>
<span class="lineNum">     177 </span>            : {
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, d, handler, expires );</span>
<a name="179"><span class="lineNum">     179 </span>            : }</a>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_timer(std::string tp, duration_t d, timer_handler handler, expires_at expires)</span>
<span class="lineNum">     182 </span>            : {
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, d, handler, expires );</span>
<a name="184"><span class="lineNum">     184 </span>            : }</a>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_async_timer(std::string tp, duration_t d, async_timer_handler handler, expires_at expires)</span>
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, d, handler, expires );</span>
<a name="189"><span class="lineNum">     189 </span>            : }</a>
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_timer(std::string tp, timer_handler handler, expires_at expires)</span>
<span class="lineNum">     192 </span>            : {
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, handler, expires );</span>
<a name="194"><span class="lineNum">     194 </span>            : }</a>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 : workflow::timer_id_t workflow::create_async_timer(std::string tp, async_timer_handler handler, expires_at expires)</span>
<span class="lineNum">     197 </span>            : {
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;create(tp, handler, expires );</span>
<span class="lineNum">     199 </span>            : }
<a name="200"><span class="lineNum">     200 </span>            : </a>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineNoCov">          0 : std::shared_ptr&lt;bool&gt; workflow::detach_timer(timer_id_t id)</span>
<span class="lineNum">     203 </span>            : {
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   return _impl-&gt;get_timer_manager()-&gt;detach(id);</span>
<a name="205"><span class="lineNum">     205 </span>            : }</a>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineCov">          7 : bool workflow::release_timer( timer_id_t id )</span>
<span class="lineNum">     208 </span>            : {
<span class="lineNum">     209 </span><span class="lineCov">          7 :   return _impl-&gt;get_timer_manager()-&gt;release(id);</span>
<a name="210"><span class="lineNum">     210 </span>            : }</a>
<span class="lineNum">     211 </span>            :   
<span class="lineNum">     212 </span><span class="lineCov">          2 : size_t workflow::timer_count() const</span>
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span><span class="lineCov">          2 :   return _impl-&gt;get_timer_manager()-&gt;size();</span>
<a name="215"><span class="lineNum">     215 </span>            : }</a>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 : size_t workflow::full_size() const</span>
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   return _impl-&gt;full_size();</span>
<a name="220"><span class="lineNum">     220 </span>            : }</a>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineCov">          2 : size_t workflow::safe_size() const</span>
<span class="lineNum">     223 </span>            : {
<span class="lineNum">     224 </span><span class="lineCov">          2 :   return _impl-&gt;safe_size();</span>
<a name="225"><span class="lineNum">     225 </span>            : }</a>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineCov">          2 : size_t workflow::unsafe_size() const</span>
<span class="lineNum">     228 </span>            : {
<span class="lineNum">     229 </span><span class="lineCov">          2 :   return _impl-&gt;unsafe_size();</span>
<a name="230"><span class="lineNum">     230 </span>            : }</a>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">          2 : size_t workflow::dropped() const</span>
<span class="lineNum">     233 </span>            : {
<span class="lineNum">     234 </span><span class="lineCov">          2 :   return _impl-&gt;dropped();</span>
<a name="235"><span class="lineNum">     235 </span>            : }</a>
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineCov">          7 : void workflow::initialize_()</span>
<span class="lineNum">     238 </span>            : {
<span class="lineNum">     239 </span><span class="lineCov">          7 :   _impl-&gt;rate_limit( _opt.rate_limit );</span>
<span class="lineNum">     240 </span><span class="lineCov">          7 :   _impl-&gt;set_startup( _handlers.startup_handler );</span>
<span class="lineNum">     241 </span><span class="lineCov">          7 :   _impl-&gt;set_finish( _handlers.finish_handler );</span>
<span class="lineNum">     242 </span><span class="lineCov">          7 :   _impl-&gt;set_statistics( _handlers.statistics_handler );</span>
<span class="lineNum">     243 </span><span class="lineCov">          7 :   this-&gt;create_wrn_timer_();</span>
<span class="lineNum">     244 </span><span class="lineCov">          7 : }</span>
<a name="245"><span class="lineNum">     245 </span>            : </a>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">          7 : void workflow::create_wrn_timer_()</span>
<span class="lineNum">     248 </span>            : {
<span class="lineNum">     249 </span><span class="lineCov">          7 :   workflow&amp; wrkf = _handlers.control_workflow == nullptr ? *this : *_handlers.control_workflow;</span>
<span class="lineNum">     250 </span>            :   
<span class="lineNum">     251 </span><span class="lineCov">          7 :   auto old_timer = _wrn_timer;</span>
<span class="lineNum">     252 </span>            :   
<span class="lineNum">     253 </span><span class="lineCov">          7 :   if ( _opt.control_ms!=0 )</span>
<span class="lineNum">     254 </span>            :   {
<span class="lineNum">     255 </span><span class="lineCov">          1 :     auto dropsave = std::make_shared&lt;size_t&gt;(0);</span>
<span class="lineNum">     256 </span><span class="lineCov">          2 :     std::function&lt;bool()&gt; control_handler;</span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :     if (  _handlers.control_handler != nullptr )</span>
<span class="lineNum">     258 </span>            :     {
<span class="lineNum">     259 </span><span class="lineCov">          1 :       control_handler = _handlers.control_handler;</span>
<span class="lineNum">     260 </span>            :     }
<span class="lineNum">     261 </span>            :     else
<span class="lineNum">     262 </span>            :     {
<a name="263"><span class="lineNum">     263 </span><span class="lineNoCov">          0 :       size_t wrnsize = _opt.wrnsize;</span></a>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       bool debug = _opt.debug;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       control_handler= [this, wrnsize, dropsave, debug]()  -&gt;bool </span>
<span class="lineNum">     266 </span>            :       {
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :         auto dropcount = this-&gt;_impl-&gt;dropped();</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :         auto us_size = this-&gt;_impl-&gt;unsafe_size();</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         auto s_size = this-&gt;_impl-&gt;safe_size();</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         auto dropdiff = dropcount - *dropsave;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         wlog::only_for_log(s_size);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         if ( dropdiff!=0 )</span>
<span class="lineNum">     273 </span>            :         {
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :           WFLOW_LOG_ERROR(&quot;Workflow '&quot; &lt;&lt; this-&gt;get_id() &lt;&lt; &quot;' queue dropped &quot; </span>
<span class="lineNum">     275 </span>            :                           &lt;&lt; dropdiff &lt;&lt; &quot; items (total &quot; &lt;&lt; dropcount &lt;&lt; &quot;, size &quot; 
<span class="lineNum">     276 </span>            :                           &lt;&lt; us_size &lt;&lt; &quot;, safe_size &quot; &lt;&lt; s_size &lt;&lt;  &quot;)&quot; )
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :           *dropsave = dropcount;</span>
<span class="lineNum">     278 </span>            :         }
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         else if ( us_size &gt; wrnsize )</span>
<span class="lineNum">     280 </span>            :         {
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :           WFLOW_LOG_WARNING(&quot;Workflow '&quot; &lt;&lt; this-&gt;get_id() &lt;&lt; &quot;' queue size warning. Size &quot; &lt;&lt; us_size &lt;&lt; &quot; safe_size &quot; &lt;&lt; s_size &lt;&lt; &quot; (wrnsize=&quot; &lt;&lt; wrnsize &lt;&lt; &quot;)&quot;)</span>
<span class="lineNum">     282 </span>            :         } 
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         else if ( debug )</span>
<span class="lineNum">     284 </span>            :         {
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :           WFLOW_LOG_MESSAGE(&quot;Workflow '&quot; &lt;&lt; this-&gt;get_id() &lt;&lt; &quot;' debug: total dropped &quot; &lt;&lt; dropcount &lt;&lt; &quot;, queue size=&quot; &lt;&lt; us_size &lt;&lt; &quot; + safe_size=&quot; &lt;&lt; s_size )</span>
<span class="lineNum">     286 </span>            :         }
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :       };</span>
<span class="lineNum">     289 </span>            :     }
<span class="lineNum">     290 </span><span class="lineCov">          2 :     _wrn_timer = wrkf.create_timer(std::chrono::milliseconds(_opt.control_ms), control_handler );</span>
<span class="lineNum">     291 </span>            :   }
<span class="lineNum">     292 </span><span class="lineCov">          7 :   wrkf.release_timer(old_timer);</span>
<a name="293"><span class="lineNum">     293 </span><span class="lineCov">          7 : }</span></a>
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            : /**
<span class="lineNum">     298 </span>            :  * @example example01.cpp
<span class="lineNum">     299 </span>            :  * @brief Простые примеры защищенных заданий в однопоточном режиме.
<span class="lineNum">     300 </span>            :  * @remark Ожидание выполнения всех заданий с помощью io_service::run работает только в однопоточном режиме.
<span class="lineNum">     301 </span>            :  */
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            : /**
<span class="lineNum">     304 </span>            :  * @example example02.cpp
<span class="lineNum">     305 </span>            :  * @brief Простые примеры незащищенных заданий в однопоточном режиме.
<span class="lineNum">     306 </span>            :  * @remark Ожидание выполнения всех заданий с помощью io_service::run работает только в однопоточном режиме.
<span class="lineNum">     307 </span>            :  */
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span>            : /**
<span class="lineNum">     310 </span>            :  * @example example03.cpp
<span class="lineNum">     311 </span>            :  * @brief Пример ограничения размера очереди.
<span class="lineNum">     312 </span>            :  * @details В этом примере при превышении размера, задания не ставятся в очередь, а сразу вызывается drop-обработчик до запуска io_service::run().
<span class="lineNum">     313 </span>            :  */
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            : /**
<span class="lineNum">     316 </span>            :  * @example example04.cpp
<span class="lineNum">     317 </span>            :  * @brief Пример ограничения размера очереди для отложенных.
<span class="lineNum">     318 </span>            :  * @details Для отложенных заданий, сначала создается таймер на постановку в очередь. Значение таймера номинальное, но сработает он только 
<span class="lineNum">     319 </span>            :  * после запуска io_service::run(), поэтому в отличии от \ref example03.cpp переполнение произойдет уже после запуска.
<span class="lineNum">     320 </span>            :  */
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span>            : /**
<span class="lineNum">     323 </span>            :  * @example example05.cpp
<span class="lineNum">     324 </span>            :  * @brief Еще пример таймера и различных заданий.
<span class="lineNum">     325 </span>            :  */
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            : /**
<span class="lineNum">     328 </span>            :  * @example example06.cpp
<span class="lineNum">     329 </span>            :  * @brief Пример многопоточной обработки.
<span class="lineNum">     330 </span>            :  * @details В этом примере, в обработчике немного засыпаем, блокируя поток, чтобы подключились другие потоки и получить красивый вывод.
<span class="lineNum">     331 </span>            :  */
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span>            : /**
<span class="lineNum">     334 </span>            :  * @example example07.cpp
<span class="lineNum">     335 </span>            :  * @brief Пример многопоточной обработки с ограничением скорости обработки.
<span class="lineNum">     336 </span>            :  * @details В этом примере ограничение на десять заданий в секунду. Первые десять заданий выполняются моментально, 
<span class="lineNum">     337 </span>            :  * а остальные более менее равномерно, но так, чтобы не превышать заданную скорость. 
<span class="lineNum">     338 </span>            :  */
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span>            : /**
<span class="lineNum">     341 </span>            :  * @example example08.cpp
<span class="lineNum">     342 </span>            :  * @brief Пример динамической реконфигурации.
<span class="lineNum">     343 </span>            :  * @details В этом примере ограничение по таймеру два раза реконфигурируем wflow::workflow, одновременно с этим, с отдельного потока,
<span class="lineNum">     344 </span>            :  * максимально загружаем его пустыми заданиями. 
<span class="lineNum">     345 </span>            :  */
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span>            : /**
<span class="lineNum">     348 </span>            :  * @example example09.cpp
<span class="lineNum">     349 </span>            :  * @brief Тестирование пропускной способности wflow::workflow с различным числом потоков на ограниченной по размеру очереди.
<span class="lineNum">     350 </span>            :  * @details Число потоков передается параметром командной строки. Как видно из результатов, для легковесных заданий, наиболее 
<span class="lineNum">     351 </span>            :  * оптимальным является конфигурация с одним выделенным потоком или однопоточный вариант. Чтобы избежать потерь достаточно 
<span class="lineNum">     352 </span>            :  * увеличить размер очереди.
<span class="lineNum">     353 </span>            :  * @remark Для отложенного на десять секунд задания для завершения работы не использовали отдельный wflow::workflow т.к. очередь
<span class="lineNum">     354 </span>            :  * состоит исключительно из легковесных заданий и не бывает такого, что все потоки зависают на обработке без возможности отработать 
<span class="lineNum">     355 </span>            :  * таймер. Смотри /ref example11.cpp, где показана подобная задержка.
<span class="lineNum">     356 </span>            :  */
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            : /**
<span class="lineNum">     359 </span>            :  * @example example10.cpp
<span class="lineNum">     360 </span>            :  * @brief Тестирование пропускной способности wflow::workflow с различным числом потоков для защищенных заданий.
<span class="lineNum">     361 </span>            :  * @details Число потоков передается параметром командной строки. Как видно из результатов, для легковесных заданий, наиболее 
<span class="lineNum">     362 </span>            :  * оптимальным является конфигурация с одним выделенным потоком или однопоточный вариант. Потерь здесь, как в /ref example09.cpp нет,
<span class="lineNum">     363 </span>            :  * но и результаты немногим хуже.
<span class="lineNum">     364 </span>            :  * @remark для отложенного на 10 секунд задания на завершения работы не использовали отдельный wflow::workflow т.к. очередь
<span class="lineNum">     365 </span>            :  * состоит исключительно из легковесных заданий и не бывает такого, что все потоки зависают на обработке без возможности отработать 
<span class="lineNum">     366 </span>            :  * таймер. Смотри /ref example11.cpp, где показана подобная задержка.
<span class="lineNum">     367 </span>            :  */
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span>            : /**
<span class="lineNum">     370 </span>            :  * @example example11.cpp
<span class="lineNum">     371 </span>            :  * @brief Пример того, как можно забить очередь так, чтобы таймеры не сработали вовремя.
<span class="lineNum">     372 </span>            :  * @details В конфигурации 4 потока отправляем 4 задания которые засыпают и не отпускают 
<span class="lineNum">     373 </span>            :  * поток на 4 секунды. Тут же отправляем отложенное на 2 секунды задание, но оно сработает
<span class="lineNum">     374 </span>            :  * только через 4 секунды, когда освободится один из потоков.
<span class="lineNum">     375 </span>            :  */
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            : /**
<span class="lineNum">     378 </span>            :  * @example example12.cpp
<span class="lineNum">     379 </span>            :  * @brief Пример того, как решить проблему с задержкой таймера из примера /ref example11.cpp.
<span class="lineNum">     380 </span>            :  * @details Для этого используем отдельный wflow::workflow для таймеров.
<span class="lineNum">     381 </span>            :  */
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            : /**
<span class="lineNum">     384 </span>            :  * @example example13.cpp
<span class="lineNum">     385 </span>            :  * @brief Простейший requester.
<span class="lineNum">     386 </span>            :  * @details В этом примере последовательность вызовов состоит из одного запроса, который выполняется раз в секунду.
<span class="lineNum">     387 </span>            :  * Для эмуляции асинхронного ответа используется тот же wflow::workflow.
<span class="lineNum">     388 </span>            :  */
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span>            : /**
<span class="lineNum">     391 </span>            :  * @example example14.cpp
<span class="lineNum">     392 </span>            :  * @brief Более сложный пример requester'в.
<span class="lineNum">     393 </span>            :  * @details В этом примере каждая вторая последовательность из десяти вызовов прерывается на пятом сообщении и начинается сначала.
<span class="lineNum">     394 </span>            :  * После отработки пяти успешных последовательностей завершаем работу.
<span class="lineNum">     395 </span>            :  */
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            : /**
<span class="lineNum">     398 </span>            :  * @example example15.cpp
<span class="lineNum">     399 </span>            :  * @brief Пример использования JSON-конфигурации
<span class="lineNum">     400 </span>            :  * @details При запуске без параметров выводится сгенерированный JSON со значениями по умолчанию. В качестве параметра 
<span class="lineNum">     401 </span>            :  * передается JSON-конфигурация для wflow::workflow, через который данные из STDIN будут отправлены в STDOUT. Можно поэкспериментировать 
<span class="lineNum">     402 </span>            :  * с многопоточностью, задержками и ограничениями скорости обработки через конфиг.
<span class="lineNum">     403 </span>            :  * ```bash
<span class="lineNum">     404 </span>            :  * time cat ../examples/example15.cpp | ./examples/example15 ../examples/example15-1.json
<span class="lineNum">     405 </span>            :  * ``` 
<span class="lineNum">     406 </span>            :  */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
